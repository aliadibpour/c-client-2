// android/app/build.gradle - modified to produce per-ABI APKs and reduce release size

apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

react {
    autolinkLibrariesWithApp()
}

// If you want to enable Hermes, uncomment the following line and clean+rebuild.
// project.ext.react = [ enableHermes: true ]

// Enable ProGuard/R8 in release builds
def enableProguardInReleaseBuilds = true

// JSC flavor (keep as-is or replace with intl if required)
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.corner"

    defaultConfig {
        applicationId "com.corner"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"

        // keep only languages you need (optional, reduces size)
        // resConfigs "en", "fa"
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }

        // Replace these placeholders with your real release keystore values.
        // It's safer to put the passwords in gradle.properties or environment variables.
        release {
            storeFile file('release-key.keystore') // <-- replace with your keystore file path
            storePassword 'REPLACE_STORE_PASSWORD' // <-- replace
            keyAlias 'REPLACE_KEY_ALIAS'           // <-- replace
            keyPassword 'REPLACE_KEY_PASSWORD'     // <-- replace
        }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
            // keep debug unminified for easier debugging
            minifyEnabled false
            shrinkResources false
        }

        release {
            // use your release keystore
            signingConfig signingConfigs.release

            // Enable R8/ProGuard and resource shrinking to reduce size
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"

            // Remove native debug symbols in release
            ndk {
                debugSymbolLevel 'NONE'
            }

            // keep jni libs in specified folder as before
            // (you may add further packagingOptions/excludes if needed)
        }
    }

    // Split APKs per ABI -> produces app-arm64-v8a-release.apk, app-armeabi-v7a-release.apk (no universal apk)
    splits {
        abi {
            enable true
            reset()
            include 'armeabi-v7a', 'arm64-v8a' // usually enough for most devices
            universalApk false
        }
    }

    sourceSets {
        main {
            jniLibs.srcDirs = ['src/main/jniLibs']
        }
    }

    // Exclude some duplicate META-INF files to avoid warnings and save a tiny amount
    packagingOptions {
        exclude "META-INF/LICENSE"
        exclude "META-INF/DEPENDENCIES"
        exclude "META-INF/NOTICE"
        exclude "META-INF/LICENSE.txt"
        exclude "META-INF/NOTICE.txt"
    }
}

dependencies {
    implementation("com.facebook.react:react-android")
    implementation project(':react-native-tdlib')

    // keep existing hermes/jsc logic
    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}
